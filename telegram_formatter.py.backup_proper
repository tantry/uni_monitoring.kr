#!/usr/bin/env python3
"""
Telegram formatter with better instructions for Adiga navigation
"""
import requests
import sys
import os
import html

sys.path.append(os.path.dirname(os.path.abspath(__file__)))

try:
    from config import BOT_TOKEN, CHAT_ID
    HAS_TELEGRAM_CONFIG = True
except ImportError:
    HAS_TELEGRAM_CONFIG = False
    BOT_TOKEN = None
    CHAT_ID = None


def escape_html(text):
    if not text:
        return ""
    text = html.escape(text)
    text = text.replace('"', '&quot;')
    text = text.replace("'", '&apos;')
    return text


def format_telegram_message(title, content, url, department="general", article_id=None):
    department_emojis = {
        'music': 'ğŸµ',
        'korean': 'ğŸ“š', 
        'english': 'ğŸ”¤',
        'liberal': 'ğŸ“–',
        'general': 'ğŸ“'
    }
    
    emoji = department_emojis.get(department, 'ğŸ“')
    
    safe_title = escape_html(title)
    safe_content = escape_html(content)
    safe_url = escape_html(url)
    
    # Truncate content
    if safe_content and len(safe_content) > 250:
        safe_content = safe_content[:250] + "..."
    
    # Format message
    message = f"{emoji} <b>[ìƒˆ ì…í•™ ê³µê³ ] {safe_title}</b>\n\n"
    
    if department != 'general':
        safe_department = escape_html(department)
        message += f"ğŸ“Œ <b>ë¶€ì„œ/í•™ê³¼</b>: {safe_department}\n"
    
    if safe_content:
        message += f"ğŸ“ <b>ë‚´ìš©</b>: {safe_content}\n"
    
    message += f"ğŸ”— <b>ë§í¬</b>: {safe_url}\n"
    
    # ADD NAVIGATION INSTRUCTIONS FOR ADIGA
    if article_id and 'adiga.kr' in url:
        message += f"\nâš  <b>Adiga.kr í˜ì´ì§€ ì•ˆë‚´:</b>\n"
        message += f"1. ë§í¬ í´ë¦­ í›„ í˜ì´ì§€ ë¡œë”© ëŒ€ê¸°\n"
        message += f"2. 'ê³µí†µ' ì¹´í…Œê³ ë¦¬ì—ì„œ ê¸°ì‚¬ ì„ íƒ\n"
        message += f"3. JavaScriptê°€ í™œì„±í™”ë˜ì–´ì•¼ í•¨\n"
        message += f"4. ê¸°ì‚¬ ID: {article_id}\n"
    
    # Add hashtags
    message += f"\n#ëŒ€í•™ì…ì‹œ"
    if department != 'general':
        message += f" #{department}"
    
    return message

def format_program(program_data):
    # Use telegram_title if available (for Adiga compatibility)
    telegram_title = program_data.get('telegram_title')
    if telegram_title:
        title = telegram_title
    else:
        title = program_data.get('title', 'No Title')
    
    content = program_data.get('content', '')
    url = program_data.get('url', '')
    
    department = program_data.get('department', 'general')
    if isinstance(department, dict):
        department = department.get('name', 'general')
    
    # Extract article ID
    article_id = None
    metadata = program_data.get('metadata', {})
    if 'article_id' in metadata:
        article_id = metadata['article_id']
    elif 'adiga_' in program_data.get('id', ''):
        article_id = program_data.get('id', '').replace('adiga_', '')
    
    return format_telegram_message(title, content, url, department, article_id)


def send_telegram_message(message, parse_mode="HTML"):
    if not HAS_TELEGRAM_CONFIG:
        print("âš  Telegram config not available")
        return False
    
    if not BOT_TOKEN or not CHAT_ID:
        print("âš  Telegram credentials not set")
        return False
    
    try:
        url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
        payload = {
            "chat_id": CHAT_ID,
            "text": message,
            "parse_mode": parse_mode,
            "disable_web_page_preview": False
        }
        
        response = requests.post(url, json=payload, timeout=10)
        
        if response.status_code == 200:
            print(f"âœ… Telegram message sent successfully")
            return True
        else:
            print(f"âŒ Telegram API error: {response.status_code} - {response.text}")
            return False
            
    except requests.exceptions.RequestException as e:
        print(f"âŒ Telegram request error: {e}")
        return False
    except Exception as e:
        print(f"âŒ Unexpected Telegram error: {e}")
        return False


format_message = format_telegram_message


class TelegramFormatter:
    def __init__(self):
        pass
    
    def format_message(self, title, content, url, department="general"):
        return format_telegram_message(title, content, url, department)
    
    def format_program(self, program_data):
        return format_program(program_data)


# Test
if __name__ == "__main__":
    print("Testing Telegram Formatter with Navigation Instructions")
    print("=" * 60)
    
    test_article = {
        'id': 'adiga_26546',
        'title': 'ì„œìš¸ëŒ€í•™êµ ìŒì•…í•™ê³¼ ì¶”ê°€ëª¨ì§‘',
        'content': 'ì„œìš¸ëŒ€í•™êµ ìŒì•…í•™ê³¼ì—ì„œ 2026í•™ë…„ë„ ì¶”ê°€ëª¨ì§‘ì„ ì‹¤ì‹œí•©ë‹ˆë‹¤.',
        'url': 'https://www.adiga.kr/uct/nmg/enw/newsDetail.do?prtlBbsId=26546',
        'department': 'music',
        'metadata': {'article_id': '26546'}
    }
    
    formatter = TelegramFormatter()
    message = formatter.format_program(test_article)
    
    print("\nFormatted message:")
    print("=" * 60)
    print(message)
    print("=" * 60)
    print(f"Length: {len(message)} chars")
    print(f"Contains navigation instructions: {'Adiga.kr í˜ì´ì§€ ì•ˆë‚´' in message}")
